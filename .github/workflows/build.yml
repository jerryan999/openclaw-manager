name: Build (macOS + Windows)

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-latest
            name: macos
          - platform: windows-latest
            name: windows

    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Install npm dependencies
        run: npm ci

      - name: Download bundled resources (macOS/Linux)
        if: matrix.name == 'macos'
        run: |
          cd src-tauri/resources
          chmod +x download-resources.sh
          ./download-resources.sh

      - name: Download bundled resources (Windows)
        if: matrix.name == 'windows'
        run: |
          cd src-tauri/resources
          ./download-resources.ps1
        shell: pwsh

      - name: Prepare portable Git resource (Windows)
        if: matrix.name == 'windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path src-tauri/resources/git | Out-Null
          $gitExe = (Get-Command git).Source
          $gitRoot = Split-Path (Split-Path $gitExe -Parent) -Parent
          Compress-Archive -Path "$gitRoot\*" -DestinationPath "src-tauri/resources/git/git-portable.zip" -Force

      - name: Prepare offline OpenClaw runtime (Windows)
        if: matrix.name == 'windows'
        shell: pwsh
        run: |
          $extractDir = "src-tauri/resources/offline/node-extract"
          if (Test-Path $extractDir) { Remove-Item -Recurse -Force $extractDir }
          Expand-Archive -Path "src-tauri/resources/nodejs/node-windows-x64.zip" -DestinationPath $extractDir -Force

          $nodeExe = Get-ChildItem -Path $extractDir -Filter node.exe -Recurse | Select-Object -First 1
          if (-not $nodeExe) { throw "node.exe not found in bundled node zip" }
          $nodeDir = Split-Path $nodeExe.FullName -Parent
          $npmCmd = Join-Path $nodeDir "npm.cmd"
          if (-not (Test-Path $npmCmd)) { throw "npm.cmd not found near node.exe" }

          $offlinePrefix = "src-tauri/resources/offline/npm-global"
          if (Test-Path $offlinePrefix) { Remove-Item -Recurse -Force $offlinePrefix }
          New-Item -ItemType Directory -Force -Path $offlinePrefix | Out-Null

          & $npmCmd install -g "src-tauri/resources/openclaw/openclaw-zh.tgz" --prefix $offlinePrefix --no-audit --fund=false --loglevel=error
          if ($LASTEXITCODE -ne 0) { throw "offline openclaw install failed with exit code $LASTEXITCODE" }
          if (-not (Test-Path "$offlinePrefix/openclaw.cmd")) { throw "openclaw.cmd not found after preinstall" }

          Remove-Item -Recurse -Force $extractDir

      - name: Build Tauri app
        run: npm run tauri build

      - name: Upload macOS artifacts
        if: matrix.name == 'macos'
        uses: actions/upload-artifact@v4
        with:
          name: openclaw-manager-macos
          path: src-tauri/target/release/bundle/

      - name: Upload Windows artifacts
        if: matrix.name == 'windows'
        uses: actions/upload-artifact@v4
        with:
          name: openclaw-manager-windows
          path: src-tauri/target/release/bundle/

  release:
    needs: build
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: openclaw-manager-macos
          path: openclaw-manager-macos

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: openclaw-manager-windows
          path: openclaw-manager-windows

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          fail_on_unmatched_files: true
          files: |
            openclaw-manager-macos/**/*.dmg
            openclaw-manager-windows/**/*.exe
            openclaw-manager-windows/**/*.msi
